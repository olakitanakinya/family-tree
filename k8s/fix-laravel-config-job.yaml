apiVersion: batch/v1
kind: Job
metadata:
  name: fix-laravel-config
  namespace: family-tree
spec:
  template:
    spec:
      containers:
      - name: fix-config
        image: olakitanakinya/family-tree:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "🔄 Fixing Laravel configuration..."
          
          # Clear caches
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          php artisan cache:clear
          
          # Fix environment configuration
          if [ -f .env ]; then
            echo "📝 Updating existing .env file..."
            sed -i 's/APP_URL=.*/APP_URL=/g' .env
            sed -i '/ASSET_URL=/d' .env
          else
            echo "📝 Creating new .env file..."
            cat > .env << 'ENVFILE'
APP_NAME="Family Tree"
APP_ENV=production
APP_KEY=base64:9jvjThP6JJA5ENjR2evQ27g3H7YE0OtCG+szdOeUsvM=
APP_DEBUG=false
APP_URL=

DB_CONNECTION=mysql
DB_HOST=mysql-service
DB_PORT=3306
DB_DATABASE=familytreedb
DB_USERNAME=familytreeuser
DB_PASSWORD=Password123

LOG_CHANNEL=stack
LOG_LEVEL=debug
ENVFILE
          fi
          
          # Laravel maintenance
          php artisan storage:link || echo "ℹ️ Storage link may already exist"
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          echo "✅ Configuration fixed successfully!"
          echo "📋 Verification:"
          php artisan tinker --execute="echo 'APP_URL: ' . config('app.url');"
          php artisan tinker --execute="echo 'Asset URL: ' . (config('app.asset_url') ?: 'Not set');"
        env:
        - name: DB_HOST
          value: "mysql-service"
        - name: DB_PORT
          value: "3306"
        - name: DB_DATABASE
          value: "familytreedb"
        - name: DB_USERNAME
          value: "familytreeuser"
        - name: DB_PASSWORD
          value: "Password123"
        - name: APP_ENV
          value: "production"
        - name: APP_KEY
          value: "base64:9jvjThP6JJA5ENjR2evQ27g3H7YE0OtCG+szdOeUsvM="
      restartPolicy: Never
  backoffLimit: 2
