apiVersion: batch/v1
kind: Job
metadata:
  name: fix-asset-urls
  namespace: family-tree
spec:
  template:
    spec:
      containers:
      - name: fix-assets
        image: olakitanakinya/family-tree:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "🔧 Fixing asset URLs..."
          
          # Update environment to remove /public from asset URLs
          sed -i 's|APP_URL=.*|APP_URL=http://98.81.89.67:30008|' /var/www/.env
          sed -i 's|ASSET_URL=.*|ASSET_URL=http://98.81.89.67:30008|' /var/www/.env
          
          # Check if there's a custom asset URL configuration in config/app.php
          if grep -q "asset_url" /var/www/config/app.php; then
            echo "📝 Found custom asset URL configuration, fixing it..."
            sed -i "s|'asset_url' =>.*|'asset_url' => env('ASSET_URL', null),|" /var/www/config/app.php
          fi
          
          # Clear all caches
          php artisan config:clear
          php artisan cache:clear
          php artisan view:clear
          php artisan route:clear
          
          # Rebuild cache
          php artisan config:cache
          php artisan view:cache
          
          echo "✅ Asset URL configuration fixed!"
          echo "APP_URL: $(grep APP_URL /var/www/.env)"
          echo "ASSET_URL: $(grep ASSET_URL /var/www/.env)"
        env:
        - name: DB_HOST
          value: "mysql-service"
        - name: DB_PORT
          value: "3306"
        - name: DB_DATABASE
          value: "familytreedb"
        - name: DB_USERNAME
          value: "familytreeuser"
        - name: DB_PASSWORD
          value: "Password123"
      restartPolicy: Never
  backoffLimit: 2
